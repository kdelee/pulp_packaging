- job-template:
    name: 'pulp-{pulp_version}-{pulp_build}-backup-{os}'
    node: '{os}-np'
    properties:
        - qe-intern
        - build-discarder:
            days-to-keep: 3
            num-to-keep: 3
            artifact-days-to-keep: 3
            artifact-num-to-keep: 12
    scm:
        - elijah-pulp-packaging-github
    wrappers:
        - config-file-provider:
            files:
                - file-id: rhn_credentials
                  variable: RHN_CREDENTIALS
        - inject:
            properties-content: |
                OS={os}
                PULP_BUILD={pulp_build}
                PULP_VERSION={pulp_version}
    builders:
        - shell:
            !include-raw-escape:
                - 'ssh-setup.sh'
        - shell:
            !include-raw-escape:
                - 'pulp-backup.sh'
        - shell: |
            if [[ "${{OS}}" =~ "rhel" ]]; then
                sudo subscription-manager unregister
                sudo subscription-manager clean
            fi
        - capture-logs
    publishers:
      - archive:
          artifacts: '*.bz2'
      - join-trigger:
          # join-trigger does not fail the build if this project doesn't exist, so we
          # do not need to ensure that there is a promote job for every release config
          projects:
            - 'pulp-2.13-stable-restore-rhel7'
      - email-notify-owners
      - mark-node-offline
