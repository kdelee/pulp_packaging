- job-template:
    name: 'elijah-pulp-{pulp_version}-{pulp_build}-backup-{os}'
    node: '{os}-np'
    properties:
        - qe-intern
    scm:
        - elijah-pulp-packaging-github
    wrappers:
        - config-file-provider:
            files:
                - file-id: rhn_credentials
                  variable: RHN_CREDENTIALS
        - inject:
            properties-content: |
                OS={os}
                PULP_BUILD={pulp_build}
                PULP_VERSION={pulp_version}
    builders:
        - shell:
            !include-raw-escape:
                - 'ssh-setup.sh'
        - shell:
            !include-raw-escape:
                - 'pulp-backup.sh'
        - trigger-builds:
            - project:
                - elijah-pulp-2.13-stable-restore-rhel7
              block: true
              block-thresholds:
                  build-step-failure-threshold: never
                  unstable-threshold: never
                  failure-threshold: never
              parameter-factories:
                  - factory: binaryfile
                    parameter-name: PRIVATE_KEY
                    file-pattern: pulp_server_key
                    no-files-found-action: FAIL
                  - factory: binaryfile
                    parameter-name: CA_CERT
                    file-pattern: cacert.pem
                    no-files-found-action: FAIL
        - copyartifact:
            project: elijah-pulp-2.13-stable-restore-rhel7
            which-build: specific-build
            build-number: ${{TRIGGERED_BUILD_NUMBER_PULP_RESTORE}}
            flatten: false
        - shell: |
            if [[ "${{OS}}" =~ "rhel" ]]; then
                sudo subscription-manager unregister
                sudo subscription-manager clean
            fi
        - capture-logs
    publishers:
      - email-notify-owners
      - mark-node-offline
